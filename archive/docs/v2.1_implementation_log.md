# V2.1 Implementation Log: Feature Expansion

**Branch:** `feature/v2-model-improvements`  
**Date:** 2025-12-07  
**Goal:** Add unused features to the model to improve accuracy

---

## 1. Current State Analysis

### V1 Model Features (33 total)

**Home Features Used (7):**
| Feature | Description | Source |
|---------|-------------|--------|
| `bedrooms` | Number of bedrooms | kc_house_data.csv |
| `bathrooms` | Number of bathrooms | kc_house_data.csv |
| `sqft_living` | Living space sqft | kc_house_data.csv |
| `sqft_lot` | Lot size sqft | kc_house_data.csv |
| `floors` | Number of floors | kc_house_data.csv |
| `sqft_above` | Above-ground sqft | kc_house_data.csv |
| `sqft_basement` | Basement sqft | kc_house_data.csv |

**Demographic Features Used (26):**
Joined from `zipcode_demographics.csv` on zipcode - includes population, income, education levels, urban/suburban percentages.

### Features Available But NOT Used (11)

From `kc_house_data.csv`:
| Feature | Type | Why We Should Add It |
|---------|------|----------------------|
| `lat` | Float | Location matters! Spatial position affects price |
| `long` | Float | Combined with lat, captures geographic value |
| `waterfront` | Binary (0/1) | **Major price driver** - waterfront homes command huge premium |
| `view` | Ordinal (0-4) | View quality directly affects price |
| `condition` | Ordinal (1-5) | House maintenance state affects value |
| `grade` | Ordinal (1-13) | Construction quality is highly predictive |
| `yr_built` | Int | House age affects price |
| `yr_renovated` | Int | Recent renovations add value |
| `sqft_living15` | Int | Avg living sqft of 15 nearest neighbors (neighborhood context) |
| `sqft_lot15` | Int | Avg lot sqft of 15 nearest neighbors |

### Why These Features Were Excluded in V1

Looking at the original `create_model.py` line 16-18:
```python
SALES_COLUMN_SELECTION = [
    'price', 'bedrooms', 'bathrooms', 'sqft_living', 'sqft_lot', 'floors',
    'sqft_above', 'sqft_basement', 'zipcode'
]
```

The original author selected only basic structural features. This was likely:
1. A simplified starting point
2. Avoiding multicollinearity (e.g., sqft_living vs sqft_above + sqft_basement)
3. Focus on "hard" features vs subjective ones (condition, view)

**But we're leaving value on the table!** Features like `waterfront`, `grade`, and `view` are known to be highly predictive.

---

## 2. V2.1 Implementation Plan

### Phase 2.1a: Add All Unused Features

We'll add ALL 11 unused features at once:
- `lat`, `long` - spatial position
- `waterfront`, `view`, `condition`, `grade` - property characteristics
- `yr_built`, `yr_renovated` - age features
- `sqft_living15`, `sqft_lot15` - neighborhood context

### Files to Modify

1. **`src/train.py`** - Update `SALES_COLUMN_SELECTION` to include new features
2. **Compare metrics** - Train new model and compare to V1 baseline

### Expected Impact

| Feature | Expected Impact | Rationale |
|---------|-----------------|-----------|
| `waterfront` | HIGH | Waterfront homes in Seattle area can be 50-100% more expensive |
| `grade` | HIGH | Construction quality (1-13 scale) directly correlates with price |
| `view` | MEDIUM-HIGH | View quality premium is significant in hilly Seattle |
| `lat/long` | MEDIUM | Captures location value not fully captured by zipcode demographics |
| `condition` | MEDIUM | Well-maintained homes fetch higher prices |
| `sqft_living15` | MEDIUM | Neighborhood context ("is this house big/small for the area?") |
| `yr_built/yr_renovated` | LOW-MEDIUM | Age matters but may be partially captured by condition |

---

## 3. Technical Details

### Before (V1)
- Total features: 33 (7 home + 26 demographic)
- RÂ² (test): 0.728
- MAE: $102,045
- RMSE: $201,659

### After (V2.1)
- Total features: 44 (18 home + 26 demographic)
- RÂ²: TBD (expecting improvement)
- MAE: TBD (expecting reduction)
- RMSE: TBD (expecting reduction)

### Code Changes Required

**train.py SALES_COLUMN_SELECTION:**
```python
# V1 (current)
SALES_COLUMN_SELECTION = [
    'price', 'bedrooms', 'bathrooms', 'sqft_living', 'sqft_lot', 'floors',
    'sqft_above', 'sqft_basement', 'zipcode'
]

# V2.1 (new)
SALES_COLUMN_SELECTION = [
    'price', 'bedrooms', 'bathrooms', 'sqft_living', 'sqft_lot', 'floors',
    'waterfront', 'view', 'condition', 'grade',
    'sqft_above', 'sqft_basement', 'yr_built', 'yr_renovated',
    'lat', 'long', 'sqft_living15', 'sqft_lot15', 'zipcode'
]
```

---

## 4. Execution Log

### Step 1: Backup V1 Metrics âœ… COMPLETE
V1 Test Metrics (baseline):
- RÂ²: 0.7281
- MAE: $102,044.70
- RMSE: $201,659.43
- Features: 33 (7 home + 26 demographic)
- Overfitting Gap: 0.1133

### Step 2: Modify train.py âœ… COMPLETE

**Changes made:**

1. **Updated docstring** - Added version history and V2.1 feature expansion notes

2. **Expanded SALES_COLUMN_SELECTION** from 9 to 19 columns:
   ```python
   # V1 (9 columns including price and zipcode):
   ['price', 'bedrooms', 'bathrooms', 'sqft_living', 'sqft_lot', 'floors',
    'sqft_above', 'sqft_basement', 'zipcode']
   
   # V2.1 (19 columns - all available features):
   ['price', 'bedrooms', 'bathrooms', 'sqft_living', 'sqft_lot', 'floors',
    'sqft_above', 'sqft_basement',
    'waterfront', 'view', 'condition', 'grade',  # NEW
    'yr_built', 'yr_renovated',                   # NEW
    'lat', 'long',                                # NEW
    'sqft_living15', 'sqft_lot15',                # NEW
    'zipcode']
   ```

3. **Updated default experiment name** from "real-estate-v1" to "real-estate-v2"

4. **Enhanced metrics output** - Added version tracking and feature breakdown

### Step 3: Retrain Model âœ… COMPLETE

Command executed:
```powershell
python src/train.py --experiment-name "real-estate-v2" --run-name "v2.1-all-features"
```

Output:
- Loaded 21,613 samples with **43 features** (was 33)
- Train set: 16,209 samples
- Test set: 5,404 samples
- MLflow model version: v2 registered

### Step 4: Compare Results âœ… COMPLETE

## ðŸŽ¯ V1 vs V2.1 COMPARISON

| Metric | V1 (Baseline) | V2.1 (Expanded) | Change | Improvement |
|--------|---------------|-----------------|--------|-------------|
| **Test RÂ²** | 0.7281 | 0.7682 | +0.0401 | **+5.5%** |
| **Test MAE** | $102,045 | $89,769 | -$12,276 | **-12.0%** |
| **Test RMSE** | $201,659 | $186,207 | -$15,452 | **-7.7%** |
| **Overfitting Gap** | 0.1133 | 0.0910 | -0.0223 | **-19.7%** |
| **Features** | 33 | 43 | +10 | +30.3% |

### Interpretation

1. **RÂ² improved by 5.5%** 
   - Model now explains 76.8% of price variance (was 72.8%)
   - This is a meaningful improvement for a KNN model

2. **MAE reduced by $12,276 (12%)**
   - Average prediction error dropped from $102k to $90k
   - On a $450k median home, error is now ~20% instead of ~23%

3. **RMSE reduced by $15,452 (7.7%)**
   - Large errors (outliers) also improved
   - High-value homes predicted more accurately

4. **Overfitting Gap reduced by 19.7%**
   - Train RÂ² (0.8592) vs Test RÂ² (0.7682) = 0.0910 gap
   - Was 0.1133 in V1
   - **Model generalizes BETTER with more features!**
   - This is counterintuitive but happens when features are truly predictive

### Feature Impact Analysis

The 10 new features added significant predictive value:

| Feature | Likely Impact | Why |
|---------|---------------|-----|
| `grade` | **HIGH** | Construction quality (1-13) is highly correlated with price |
| `waterfront` | **HIGH** | Seattle waterfront properties are 50-100% premium |
| `view` | **MEDIUM-HIGH** | View quality matters in hilly Seattle |
| `lat/long` | **MEDIUM** | Location nuances beyond zipcode |
| `sqft_living15` | **MEDIUM** | Neighborhood context helps |
| `condition` | **MEDIUM** | Maintenance state affects value |
| `yr_built` | **LOW-MEDIUM** | Age effect (partially captured elsewhere) |

### Conclusion

**V2.1 is a clear winner.** Adding the unused features improved:
- Accuracy (lower MAE/RMSE)
- Explanatory power (higher RÂ²)
- Generalization (lower overfitting)

The model is now more accurate AND more robust.

---

## 5. API Updates for V2.1

### Step 5: Update API to Use All 17 Features âœ… COMPLETE

**Files Modified:**

1. **`src/models.py`** - Updated `get_model_features()`:
   - V1: Returned 7 features
   - V2.1: Returns all 17 home features
   
2. **`src/services/feature_service.py`** - Added V2.1 default values:
   - New constant `V21_DEFAULT_FEATURES` with defaults for 10 new features
   - Updated `enrich_features_with_average()` to fill in defaults for minimal endpoint
   
3. **`src/services/model_service.py`** - Added version detection:
   - Auto-detects v1 (33 features) vs v2.1 (43 features) based on feature count

### V2.1 Default Values for Minimal Endpoint

When `/predict-minimal` is called with only 7 features, these defaults are used:

| Feature | Default | Rationale |
|---------|---------|-----------|
| `waterfront` | 0 | 99%+ of homes are not waterfront |
| `view` | 0 | Most homes have no special view |
| `condition` | 3 | Average (1-5 scale) |
| `grade` | 7 | Average construction grade |
| `yr_built` | 1975 | Median year built |
| `yr_renovated` | 0 | Most never renovated |
| `lat` | 47.5601 | King County center |
| `long` | -122.2139 | King County center |
| `sqft_living15` | 1986 | Median neighbor sqft |
| `sqft_lot15` | 7620 | Median neighbor lot |

### Step 6: Test API with V2.1 Model âœ… COMPLETE

**Test Results (2025-12-08):**
- Health check: âœ… Model version detected as "v2.1"
- Full predictions: âœ… 5/5 successful
- Minimal predictions: âœ… 3/3 successful

**Sample Predictions:**
| Example | ZIP | V2.1 Price |
|---------|-----|------------|
| 1 | 98118 | $414,520 |
| 2 | 98115 | $706,400 |
| 3 | 98030 | $303,800 |
| 4 | 98005 | $629,000 |
| 5 | 98126 | $254,425 |

---

## V2.1 IMPLEMENTATION COMPLETE âœ…

### Summary of Changes

| Component | V1 | V2.1 |
|-----------|-----|------|
| Model features | 33 | 43 (+10) |
| Home features | 7 | 17 (+10) |
| Test RÂ² | 0.7281 | 0.7682 (+5.5%) |
| Test MAE | $102,045 | $89,769 (-12%) |
| Overfitting gap | 0.1133 | 0.0910 (-20%) |

### Files Modified

1. `src/train.py` - Expanded SALES_COLUMN_SELECTION to 18 columns
2. `src/models.py` - Updated get_model_features() to return all 17 features
3. `src/services/feature_service.py` - Added V21_DEFAULT_FEATURES for minimal endpoint
4. `src/services/model_service.py` - Added version auto-detection
5. `model/model.pkl` - Retrained with 43 features
6. `model/model_features.json` - Updated feature list
7. `model/metrics.json` - New metrics

### Next Steps

- [ ] Commit V2.1 changes to feature branch
- [ ] Consider V2.2: Feature engineering (distance_to_downtown, relative_size, house_age)
- [ ] Consider V2.3: Hyperparameter tuning
- [ ] Consider V2.4: Try tree-based models (Random Forest, XGBoost)

---

**V2.1 Completed:** 2025-12-08
**Total Improvement:** RÂ² +5.5%, MAE -12%, better generalization

---

## 5. Learning Notes

### Why KNN Benefits from More Features

K-Nearest Neighbors works by finding the K closest training examples in feature space. Adding more relevant features:

1. **Better Distance Calculation**: KNN uses Euclidean (or other) distance. More features = more dimensions to differentiate homes.

2. **Waterfront Example**: In V1, a waterfront and non-waterfront home with same sqft/beds might be "close" in feature space. With `waterfront` feature, they're now far apart (0 vs 1).

3. **RobustScaler Matters**: Our pipeline uses RobustScaler, which handles outliers well. Important for features like `yr_built` (wide range: 1900-2015).

### Potential Concerns

1. **Curse of Dimensionality**: With KNN, too many features can dilute signal. Going from 33â†’44 features is a 33% increase. Monitor for degradation.

2. **Feature Correlation**: Some features are correlated:
   - `sqft_living` â‰ˆ `sqft_above` + `sqft_basement`
   - `sqft_living` vs `sqft_living15` (might be similar in uniform neighborhoods)
   
   KNN is robust to correlated features (unlike linear regression), so this is acceptable.

3. **Ordinal Encoding**: Features like `grade` (1-13) are treated as numeric. KNN handles this fine since it uses distance, not coefficients.

---

**Log Updated:** 2025-12-07
**Next Action:** Modify train.py
