# V2.1.2: Adaptive Endpoint Discovery

**Project:** Real Estate Price Predictor  
**Date:** 2025-12-08  
**Version:** V2.1.2 (Experimental)

---

## Discovery Summary

During comparison testing of `/predict-minimal` vs `/predict-full`, a significant **price-tier bias** was discovered:

| Price Tier | More Accurate Endpoint | Win Rate |
|------------|------------------------|----------|
| < $400,000 | `/predict-minimal` | ~80% |
| ≥ $400,000 | `/predict-full` | ~75% |

This insight led to the creation of an adaptive routing endpoint.

---

## The Observation

From the initial 20-sample comparison:

### Low-Value Homes (< $400K)
| Example | Gold Price | Minimal Error | Full Error | Winner |
|---------|------------|---------------|------------|--------|
| 3 | $303,800 | $13,710 | $20,580 | minimal |
| 5 | $254,425 | $14,415 | $62,525 | minimal |
| 7 | $247,600 | $49,800 | $56,980 | minimal |
| 14 | $358,470 | $80,280 | $88,780 | minimal |

**Pattern:** For modest homes, the conservative defaults in `/predict-minimal` work well.

### High-Value Homes (≥ $400K)
| Example | Gold Price | Minimal Error | Full Error | Winner |
|---------|------------|---------------|------------|--------|
| 2 | $706,400 | $404,300 | $379,410 | full |
| 4 | $629,000 | $339,435 | $268,900 | full |
| 9 | $1,049,100 | $733,710 | $672,700 | full |
| 15 | $780,500 | $386,220 | $327,700 | full |

**Pattern:** For high-value homes, specific property details (waterfront, grade, view) matter more.

---

## Why This Happens

### Hypothesis: Feature Sensitivity by Price Tier

**Low-value homes** ($300K-$400K):
- Typically similar characteristics (no waterfront, average grade/condition)
- Location is main differentiator → captured by demographics
- Extra features add noise, not signal
- Defaults are close to actual values

**High-value homes** (> $400K):
- Wide variation in characteristics
- Often have premium features (waterfront, views, high grade)
- Specific values matter → defaults underestimate
- Lat/long capture premium neighborhood micro-location

---

## Adaptive Strategy Implementation

### Algorithm

```python
THRESHOLD = $400,000

def predict_adaptive(features):
    # Step 1: Estimate price using all 17 features
    initial_estimate = predict_full(features)
    
    # Step 2: Route based on tier
    if initial_estimate >= THRESHOLD:
        return predict_full(features)  # Already computed
    else:
        return predict_minimal(features[:7])  # Use defaults
```

### API Endpoint

```
POST /api/v1/predict-adaptive
```

**Request:** Same as `/predict-full` (all 17 home features required)

**Response:** Includes strategy metadata
```json
{
    "predicted_price": 425000.00,
    "model_version": "v2.1-adaptive",
    "confidence_note": "Adaptive routing: HIGH tier → full_features. Estimated price $432,000 >= $400,000 threshold."
}
```

---

## Expected Performance

Based on simulated analysis:

| Strategy | Avg Error | Relative |
|----------|-----------|----------|
| `/predict-minimal` (always) | $213,390 | baseline |
| `/predict-full` (always) | $193,486 | -9.3% |
| `/predict-adaptive` (tier) | **~$185,000** | **-13%** (estimated) |

**Improvement over best single strategy:** ~5-10%

---

## Testing the Adaptive Endpoint

### Start API
```bash
uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload
```

### Run Tier Analysis
```bash
python scripts/compare_endpoints_by_tier.py
```

### Manual Test
```bash
# High-value home (should use full strategy)
curl -X POST "http://localhost:8000/api/v1/predict-adaptive" \
  -H "Content-Type: application/json" \
  -d '{
    "bedrooms": 4, "bathrooms": 3.0, "sqft_living": 3500,
    "sqft_lot": 10000, "floors": 2.0, "sqft_above": 2500,
    "sqft_basement": 1000, "waterfront": 1, "view": 4,
    "condition": 4, "grade": 10, "yr_built": 2010,
    "yr_renovated": 0, "lat": 47.65, "long": -122.35,
    "sqft_living15": 3000, "sqft_lot15": 8000
  }'

# Low-value home (should use minimal strategy)
curl -X POST "http://localhost:8000/api/v1/predict-adaptive" \
  -H "Content-Type: application/json" \
  -d '{
    "bedrooms": 3, "bathrooms": 1.5, "sqft_living": 1200,
    "sqft_lot": 5000, "floors": 1.0, "sqft_above": 1200,
    "sqft_basement": 0, "waterfront": 0, "view": 0,
    "condition": 3, "grade": 7, "yr_built": 1960,
    "yr_renovated": 0, "lat": 47.50, "long": -122.20,
    "sqft_living15": 1400, "sqft_lot15": 6000
  }'
```

---

## Limitations

1. **Threshold is hard-coded** - $400K was found empirically but may not generalize
2. **Circular dependency** - Uses `/predict-full` to decide tier, which may have error
3. **Only tested on 20-50 samples** - Need larger validation
4. **Assumes King County patterns** - May not apply to other markets

---

## Future Improvements

1. **Data-driven threshold** - Find optimal cutpoint from training data
2. **Multi-tier routing** - LOW / MEDIUM / HIGH with different strategies
3. **Ensemble averaging** - Weighted combination of both predictions
4. **ML-based routing** - Train a classifier to pick the best strategy

---

## Key Insight

> **"The best prediction strategy depends on the price tier of the home."**

This is a form of **model stacking** or **meta-learning** where we use characteristics of the input to route to the best predictor.

---

**Document Version:** 1.0  
**Last Updated:** 2025-12-08
